name: build_for_android

on:
  push:
    tag:
      - "v*.*.*"

jobs:
  build:

    runs-on: self-hosted

    steps:
    # Setup Java environment in order to build the Android app.
    - uses: actions/checkout@v1
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    
    # Flutter Setup
    - uses: subosito/flutter-action@v1
      with:
        channel: 'stable'
        flutter-version: '2.8.0'
    
    - run: flutter pub get

    - name: Dectypt keys
      run: |
        echo "${{ secrets.ANDROID_RELEASE_KEYSTORE }}" > android/release.keystore.asc
        echo "${{ secrets.KEY_PROPERTIES }}" > android/key.properties.asc
        gpg -d --passphrase "${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSPHRASE }}" --batch android/release.keystore.asc > android/app/release.keystore
        gpg -d --passphrase "${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSPHRASE }}" --batch android/key.properties.asc > android/key.properties
    
    - name: Get Tag name (version code)
      uses: olegtarasov/get-tag@v2
      id: tagName
      with:
        tagRegex: 'v([0-9]+.[0-9]+.[0-9]+)' # Optional. Returns specified group text as tag name. Full tag string is returned if regex is not defined.
        tagRegexGroup: 1 # Optional. Default is 1.

    - name: Build AAB
      run: flutter build appbundle --release --build-number "${{ github.run_number }}" --build-name $GIT_TAG_NAME

    - name: Create Github Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "build/app/outputs/bundle/release/*.aab"
        token: ${{ secrets.PERSONAL_RELEASE_TOKEN }}

    - name: Save APPBUNDLE to Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: APPBUNDLE
        path: build/app/outputs/bundle/release/app-release.aab

