name: build_for_android

on:
  push:
#    tag:
#      - "v*.*.*"

jobs:
  build:

    runs-on: self-hosted

    steps:
    # Setup Java environment in order to build the Android app.
    - uses: actions/checkout@v1
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    
    # Flutter Setup
    - uses: subosito/flutter-action@v1
      with:
        channel: 'stable'
        flutter-version: '2.8.0'
    
    - run: flutter pub get

    - name: Dectypt keys
      run: |
        echo "${{ secrets.ANDROID_RELEASE_KEYSTORE }}" > android/release.keystore.asc
        echo "${{ secrets.KEY_PROPERTIES }}" > android/key.properties.asc
        gpg -d --passphrase "${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSPHRASE }}" --batch android/release.keystore.asc > android/app/release.keystore
        gpg -d --passphrase "${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSPHRASE }}" --batch android/key.properties.asc > android/key.properties

    - name: Build AAB
      run: flutter build appbundle --release

